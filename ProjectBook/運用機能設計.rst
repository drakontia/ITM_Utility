****************
5. 運用機能設計
****************

ここでは、以下の機能概要について記載する。

* 冗長化機能

* バックアップ機能

* ログ管理機能

* 自動化機能

* 自己監視機能

5.1. 冗長化機能
=================

5.1.1. 冗長化設計（ObjectServer）
------------------------------------

(1) 冗長化設計概要

ObjectServerはソフトウェア機能による冗長構成をとる。正系と副系の2筐体でObjectServerが稼動する。

2台のObjectServerは、Bi-Gatewayというコンポーネントでデータの同期や、正副の切り替え制御を行う。

ObjectServerへ接続する各種Probeや監視コンソールは、正副両サーバーのアドレスを所有し、正系との通信ができない場合、自動的に副系との通信を行う。


5.1.2. 冗長化設計（SNMP Probe）
----------------------------------

SNMP Probeはソフトウェア機能による冗長構成をとる。正/副共にSNMP Probeを導入し、常時正系と副系の間で一定間隔でハートビート通信を行うことで生存確認を行う。

正系のSNMP Probeが停止した場合は、副系でハートビート通信の停止を検知し、ObjectServerにイベント送信を開始する。


5.1.3. 冗長化設計（EIF Probe）
---------------------------------


正系、副系の両筐体に導入されたEIF Probeは、ソフトウェア機能による冗長構成は取らず、それぞれ別々に稼働する。

監視対象は正副両方の送信先アドレスを所有し、通常正系へのイベント転送を行うが、正系への通信ができない場合、自動的に副系へのイベント転送を開始する。

EIF Probeは監視対象側で正副の切り替え制御を行う。

5.1.4. 冗長化設計（ITM）
---------------------------

正系、副系の両筐体にITMはバイナリデータを持つが、データ（TEMS DBおよびTEPS DB）は共用VG上に配置する
PowerHA によって冗長化を実現、制御する

5.1.5. 冗長化設計（ITNM）
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

正系、副系の両筐体に導入されたITNMおよびNCIM DB(Informix)は、ソフトウェア機能による冗長構成をとって稼働する。

ポーリングは、通常正系から行い、DB Replication機能で副系にデータ同期される

5.2. バックアップ設計
=======================

バックアップ設計は次の項目に分け、設計を行う。

* システムバックアップ（ボリューム・グループ含む）

* ミドルウェア製品構成情報

* 監視イベント情報

5.2.1. システムバックアップ設計
----------------------------------

  (1) バックアップ取得対象
    システムのイメージをすべて対象とする。
    データセンターでの災害、サーバー自体のハードウェアに類する故障に対して備える。

  (2) バックアップ取得タイミング
    大規模改修に伴い、事前にシステムバックアップを実施する。

  (3) バックアップ取得方法
    テープメディアにバックアップファイルを取得。

5.2.2. ミドルウェアバックアップ設計
------------------------------------------------

  (1) バックアップ取得対象

.. csv-table::
  :header-rows: 1

  製品,取得ログ内容
  Netcool/OMNIbus,ユーザー情報（M/W上のユーザーのみ）
  ,Event DB構成情報
  ,自動化構成情報（Trigger設定）
  ITM,構成情報(EIB)
  ,コンソール構成情報(DB)
|
稼動時におけるミドルウェアへの悪影響、各種作業における設定ミスなどに対して備える。

  (2) バックアップ取得タイミング
    計画停止時、変更作業時の前に実施する。

  (3) バックアップ取得方法
    Netcool/OMNIbusについては、製品コマンドにより構成情報のデータ出力を行い、保管する。

5.2.3 監視イベントバックアップ設計
----------------------------------------

  (1) バックアップ取得対象

.. csv-table::
  :header-rows: 1

  監視イベント情報,説明
  イベント受信ログ,自動化処理前の受信時のイベント情報
  監視対象イベントログ,監視対象の障害イベント情報
  抑止イベントログ,計画停止により監視対象外（抑止）となったイベント情報
  イベント削除ログ,イベントデータベースから削除されるイベント情報
|

  (2) バックアップ取得タイミング
    イベントが書き出されたタイミング。もしくはイベントが削除されるタイミング。

  (3) バックアップ取得方法
    監視システムで受信されたイベントは、イベント受信時とイベント運用処理後にイベントログへ書き出される。
    イベントログの書き出しは、ObjectServerのTriggerにより実装される。

5.3. ログ管理設計
===================

日次で保管するログについては、セキュリティポリシーに基づき、必要な世代数のバックアップを保管し、メンテナンスを実施する。

ログメンテナンス処理は、ログメンテナンスツール(logmgr）をcronに設定し、実行する。

なお、日次保管の必要なログは以下の通りである。詳細のログ名については詳細設計で記載する。

.. csv-table::
    :header-rows: 1

    メンテナンス項目,対象,説明
    サーバーログ,Netcool/OMNIbus,ObjectServerとProbe間通信、稼動状態に関するエラーメッセージを出力するログ
    エージェントログ

5.4. 自動化設計
=================

次に起動・停止制御・メンテナンス方法に関して、統合監視サーバと監視対象サーバの各コンポーネント毎に記載する。

  (1) 起動設計

.. csv-table::
    :header-rows: 1

    サーバー,コンポーネント,起動方法,備考
    統合監視サーバ,ObjectServer,inittab,PA制御のため、PAの起動を行うスクリプトを実装する
    Bi-Gateway（副系のみ）,inittab,PA制御のため、PAの起動を行うスクリプトを実装する
    EIF Probe,inittab,PA制御のため、PAの起動を行うスクリプトを実装する
    SNMP Probe,inittab,PA制御のため、PAの起動を行うスクリプトを実装する
    Ping Probe,inittab,PA制御のため、PAの起動を行うスクリプトを実装する
    Process Agent,inittab
    監視対象サーバ　※1,Syslog Probe,inittab,PA制御のため、PAの起動を行うスクリプトを実装する
    Process Agent,inittab

|
  (2)停止設計
    停止設計はすべてスクリプトによる停止となる。

.. csv-table::
    :header-rows: 1

    サーバー,コンポーネント,停止方法,備考
    統合監視サーバ,ObjectServer,ジョブ,PA制御のため、PAの停止を行うスクリプトを実装する
    Bi-Gateway（副系のみ）,ジョブ,PA制御のため、PAの停止を行うスクリプトを実装する
    EIF Probe,ジョブ,PA制御のため、PAの停止を行うスクリプトを実装する
    SNMP Probe,ジョブ,PA制御のため、PAの停止を行うスクリプトを実装する
    Ping Probe,ジョブ,PA制御のため、PAの停止を行うスクリプトを実装する
    Process Agent,ジョブ
    監視対象サーバ　※1,Syslog Probe,ジョブ,PA制御のため、PAの起動を行うスクリプトを実装する
    Process Agent,ジョブ
|
  (3) メンテナンス設計
    メンテナンスはJP1に登録されたスクリプトにより定期的に実行される。

5.5. 自己監視機能
===================

監視サービス自身の監視は次の方法で行う。

.. csv-table::
    :header-rows: 1

    サーバー,コンポーネント,監視方法
    統合監視サーバ,ObjectServer,Netcoolサーバーとのハートビート監視
    Bi-Gateway（副系のみ）,ObjectServerとの接続確認
    EIF Probe,Probeのハートビート機能により監視
    SNMP Probe,Probeのハートビート機能により監視
    監視対象サーバ,Syslog Probe,Probeのハートビート機能により監視
